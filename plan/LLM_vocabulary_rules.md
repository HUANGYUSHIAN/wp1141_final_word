# LLM 單字本生成規範

本文檔定義了使用 LLM（OpenAI GPT-4o-mini）生成單字本時的所有規範和規則。

## 1. 語言限制

系統僅支援以下三種語言：
- **日文** (Japanese)
- **繁體中文** (Traditional Chinese)
- **英文** (English)

所有 `langUse` 和 `langExp` 參數必須是上述三種語言之一。

## 2. 單字數量要求

- **目標數量**：30 個單字
- **最低接受數量**：25 個單字
- **生成策略**：如果第一次生成不足 25 個，系統會自動請求繼續生成，最多嘗試 3 次
- **詞性要求**：
  - 前兩次嘗試：必須至少包含 5 個動詞、5 個形容詞、5 個名詞
  - 第三次嘗試：詞性要求放寬（若可行仍盡量包含動詞/形容詞/名詞）

## 3. 程度等級

系統支援三種程度等級，影響單字難度：

- **初級**：使用常見、基礎詞彙
- **中級**：使用中階詞彙，包含較長或抽象概念
- **高級**：使用進階、少見或專業詞彙，詞彙難度明顯高於初級與中級

## 4. 語言使用規則

### 4.1 Word.word（單字本身）
- 必須使用 `langUse` 指定的語言
- 不能為空
- 不能與已生成的單字重複

### 4.2 Word.spelling（拼音/發音）

#### 日文 (Japanese)
- **絕對不能為 null**
- 規則：
  - 如果 `word` 包含漢字 → `spelling` 必須是該單字的平假名讀音
    - 例如：`刺身` → `さしみ`
  - 如果 `word` 是純平假名（無漢字、無片假名）→ `spelling` 必須與 `word` 相同
    - 例如：`おすすめ` → `おすすめ`（不能是 null）
  - 如果 `word` 是純片假名（無漢字、無平假名）→ `spelling` 必須與 `word` 相同
    - 例如：`メニュー` → `メニュー`（不能是 null）

#### 繁體中文 (Traditional Chinese)
- **絕對不能為 null**
- 必須填寫注音
- 例如：`你好` → `ㄋㄧˇ ㄏㄠˇ`

#### 英文 (English)
- **必須為 null**
- 英文不需要拼音欄位

### 4.3 Word.explanation（解釋）
- 必須使用 `langExp` 指定的語言
- 不能為空
- 必須準確描述單字的含義

### 4.4 Word.partOfSpeech（詞性）
- 必須使用 `langExp` 指定的語言
- 可以為 null（但建議填寫）
- **特殊規則**：若為日文動詞，必須標示動詞類別
  - 格式：`動詞(I)`、`動詞(II)`、`動詞(III)`
  - 例如：`動詞(I)`、`動詞(II)`、`動詞(III)`

### 4.5 Word.sentence（例句）

#### 語言要求
- 必須使用 `langUse` 指定的語言
- 不能為空

#### 格式要求
- **必須包含該單字**
- **格式**：`<單字<`（用左尖括號包裹單字）
  - ✅ 正確範例：`<運営<が円滑に行われています。`
  - ❌ 錯誤範例：`...<運営<...が円滑に行われています。`（不要字面顯示 `...`）
  - ❌ 錯誤範例：`<運営>`（不能使用右尖括號 `>`）
  - ❌ 錯誤範例：`運営が円滑に行われています。`（單字沒有被標記包裹）

#### 時態變化規則
- **允許**：單字在句子中可以使用時態變化（如動詞變形、名詞複數等）
  - 例如：單字是 `運営する`，句子中可以使用 `運営`、`運営した`、`運営している` 等形式
- **不允許**：
  - 不能變成其他單字
  - 必須符合 `explanation` 的意思
  - 例如：單字是 `運営`（經營），不能變成 `運用`（運用）

## 5. 數據驗證規則

系統會自動驗證以下項目：

1. **必填欄位**：`word`、`explanation`、`sentence` 不能為空
2. **句子格式**：`sentence` 必須包含 `<word<` 格式
3. **Spelling 規則**：
   - 日文和繁體中文的 `spelling` 不能為 null
   - 英文的 `spelling` 必須為 null
4. **自動修正**：
   - 日文純平假名或純片假名的 `spelling` 如果為 null，系統會自動填充為 `word` 的值

## 6. 重複檢查

- 系統會檢查並過濾重複的單字
- 在多次生成嘗試中，會避免與已生成的單字重複

## 7. 輸出格式

LLM 必須以 JSON 格式返回：

```json
{
  "words": [
    {
      "word": "單字",
      "spelling": "拼音或null",
      "explanation": "解釋",
      "partOfSpeech": "詞性",
      "sentence": "例句"
    }
  ]
}
```

## 8. 錯誤處理

- 如果生成不足 25 個有效單字，系統會返回錯誤
- 如果 JSON 解析失敗，系統會嘗試提取 JSON 部分
- 無效的單字（不符合規範）會被自動過濾

## 9. 後處理邏輯

系統在接收 LLM 回應後會進行以下處理：

1. **解析 JSON**：安全解析 LLM 返回的 JSON
2. **標準化**：清理空白字符
3. **自動填充**：日文純假名的 `spelling` 自動填充
4. **驗證過濾**：移除不符合規範的單字
5. **合併去重**：與已生成的單字合併並去重

## 10. 範例

### 日文單字範例

```json
{
  "word": "運営",
  "spelling": "うんえい",
  "explanation": "經營、管理",
  "partOfSpeech": "名詞",
  "sentence": "<運営<が円滑に行われています。"
}
```

```json
{
  "word": "おすすめ",
  "spelling": "おすすめ",
  "explanation": "推薦",
  "partOfSpeech": "名詞",
  "sentence": "このレストランは<おすすめ<です。"
}
```

```json
{
  "word": "メニュー",
  "spelling": "メニュー",
  "explanation": "菜單",
  "partOfSpeech": "名詞",
  "sentence": "<メニュー<を見て注文します。"
}
```

### 繁體中文單字範例

```json
{
  "word": "經營",
  "spelling": "ㄐㄧㄥ ㄧㄥˊ",
  "explanation": "管理、運作",
  "partOfSpeech": "動詞",
  "sentence": "他<經營<一家餐廳。"
}
```

### 英文單字範例

```json
{
  "word": "manage",
  "spelling": null,
  "explanation": "管理、經營",
  "partOfSpeech": "動詞",
  "sentence": "He <manage<s a restaurant."
}
```

## 11. 更新記錄

- 2025-01-XX：初始版本
- 2025-01-XX：修正日文純假名的 spelling 規則
- 2025-01-XX：修正句子格式說明（移除字面 `...` 顯示）
- 2025-01-XX：添加時態變化規則說明

